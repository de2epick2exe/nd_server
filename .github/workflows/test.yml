name: Main tests
on:
  workflow_call:
    inputs:
      testBranch: # Define the input
        description: "The branch to test"
        required: true
        type: string
    secrets:
      DB_NAME: {}
      DB_USER: {}
      DB_PASS: {}
      DB_HOST: {}
      DB_PORT: {}
      SH_HOST: {}
      SH_USER: {}
      SH_KEYY: {}
      SH_PASS: {}
jobs:
  test:
    runs-on: self-hosted
    environment: DBSCRT
    steps:
      - name: Echo Test
        run: echo "Hello, GitHub Actions!"

      - name: Get repository code
        uses: actions/checkout@v3

      - name: Set Up NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: "23"

      - name: Install dependencies
        run: npm install

      - name: Set Environment Variables for .env
        env:
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
        run: |
          echo "DB_NAME=$DB_NAME" 
          echo "DB_USER=$DB_USER" 
          echo "DB_PASS=$DB_PASS" 
          echo "DB_HOST=$DB_HOST" 
          echo "DB_PORT=$DB_PORT" 

      - name: Run Tests
        run: npm test
        env:
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}

      - name: Run Build
        run: npm run build
        env:
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}

      - name: Run test for build
        run: npm run test:build
        env:
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
